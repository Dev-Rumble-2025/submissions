<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Teacher — Assignments (Connected)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{--blue:#0f2a5f;--muted:#64748b}
  *{box-sizing:border-box}
  body{margin:0;font-family:Poppins, sans-serif;background:#f8fafc;color:#0f1724}
  .navbar{background:linear-gradient(90deg,var(--blue),#0b1f47);color:white;padding:12px 20px}
  .container{max-width:1100px;margin:18px auto;padding:0 16px}
  .card{background:white;border-radius:12px;padding:14px;box-shadow:0 6px 24px rgba(11,20,40,0.04);border:1px solid #eef2f7}
  .row{display:flex;gap:12px}
  .assign-item{padding:10px;border-radius:8px;border:1px solid #f1f5f9;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
  .btn{background:var(--blue);color:white;padding:8px 10px;border:none;border-radius:8px;cursor:pointer}
  input,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef7}
</style>
</head>
<body>
  <header class="navbar"><div style="font-weight:700">Assignments</div></header>
  <main class="container">
    <div class="card">
      <h2 style="margin-top:0">Create Assignment (publishes to students)</h2>
      <div style="display:grid;grid-template-columns:1fr 220px;gap:12px;margin-top:12px">
        <div>
          <label>Title</label><input id="aTitle" />
          <label style="margin-top:8px">Description</label><textarea id="aDesc" rows="3"></textarea>
          <label style="margin-top:8px">Due (datetime)</label><input id="aDue" type="datetime-local" />
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="createA" class="btn">Create & Publish</button>
          <button id="clearA" style="background:#fff;border:1px solid #e6eef7;padding:8px;border-radius:8px">Clear</button>
          <div style="margin-top:auto;color:var(--muted)">Adding an assignment writes to both teacher and student lists and notifies students.</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <h3 style="margin:0 0 8px 0">Assignments</h3>
        <div id="assignList"></div>
      </div>
    </div>
  </main>

<script>
function safeParse(key, fallback){ try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); } catch(e){ return fallback; } }

let assignments = safeParse('tc_assignments', []);
// Save to both teacher and shared student storage, and add shared notification
function saveAssignmentBoth(a){
  assignments.push(a);
  localStorage.setItem('tc_assignments', JSON.stringify(assignments));

  const shared = safeParse('cc_assignments', []);
  shared.push(a);
  localStorage.setItem('cc_assignments', JSON.stringify(shared));

  const notifs = safeParse('cc_notifications', []);
  notifs.push({id:'n'+Date.now(), text:`New assignment: ${a.title} (due ${a.due||'N/A'})`, at:Date.now()});
  localStorage.setItem('cc_notifications', JSON.stringify(notifs));
}

function render(){
  const list = document.getElementById('assignList'); list.innerHTML='';
  if(assignments.length===0) list.innerHTML = '<div style="color:#64748b">No assignments yet.</div>';
  assignments.forEach(a=>{
    const div = document.createElement('div'); div.className='assign-item';
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:600">${a.title}</div><div style="color:#64748b">${a.description||''}<br><small>Due: ${a.due?new Date(a.due).toLocaleString():'—'}</small></div>`;
    const right = document.createElement('div');
    right.innerHTML = `<button onclick='toggleGraded("${a.id}")' style="margin-right:8px">${a.graded?'Unmark Graded':'Mark Graded'}</button><button onclick='deleteA("${a.id}")' style="background:#fff;border:1px solid #f1f5f9;padding:6px;border-radius:6px">Delete</button>`;
    div.appendChild(left); div.appendChild(right);
    list.appendChild(div);
  });
}

document.getElementById('createA').addEventListener('click', ()=>{
  const title = document.getElementById('aTitle').value.trim();
  if(!title) return alert('Title required');
  const a = {id:'a'+Date.now(), title, description:document.getElementById('aDesc').value.trim(), due: document.getElementById('aDue').value||null, graded:false, createdAt:Date.now()};
  saveAssignmentBoth(a);
  render();
  document.getElementById('aTitle').value=''; document.getElementById('aDesc').value=''; document.getElementById('aDue').value='';
});

function deleteA(id){
  assignments = assignments.filter(x=>x.id!==id);
  localStorage.setItem('tc_assignments', JSON.stringify(assignments));
  // remove from shared list
  const shared = safeParse('cc_assignments', []).filter(x=>x.id!==id);
  localStorage.setItem('cc_assignments', JSON.stringify(shared));
  render();
}
function toggleGraded(id){
  const a = assignments.find(x=>x.id===id); if(!a) return;
  a.graded = !a.graded;
  localStorage.setItem('tc_assignments', JSON.stringify(assignments));
  // also update shared
  const shared = safeParse('cc_assignments', []).map(x=> x.id===id ? a : x );
  localStorage.setItem('cc_assignments', JSON.stringify(shared));
  render();
}

render();

// Listen for storage changes (other tabs)
window.addEventListener('storage', (e)=>{
  if(e.key === 'tc_assignments' || e.key === 'cc_assignments' || e.key === 'cc_notifications'){
    assignments = safeParse('tc_assignments', assignments);
    render();
  }
});
</script>
</body>
</html>
